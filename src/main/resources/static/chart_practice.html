<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê°€ê²© ì˜ˆì¸¡ ì°¨íŠ¸</title>
    <!-- Chart.js ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ CDNìœ¼ë¡œ ë¶ˆëŸ¬ì˜´ - ì°¨íŠ¸ë¥¼ ê·¸ë¦¬ê¸° ìœ„í•´ í•„ìš” -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        #predictionForm { margin-bottom: 20px; }
        #predictionForm input { margin-right: 10px; padding: 5px; }
        #explanation { margin-top: 20px; padding: 10px; border: 1px solid #ccc; border-radius: 5px; }
    </style>
</head>
<body>

    <h1>ê°€ê²© ì˜ˆì¸¡</h1>

    <!-- ì‚¬ìš©ì ì…ë ¥ í¼ -->
    <div id="predictionForm">
        <div style="display: flex; flex-wrap: wrap; align-items: center; gap: 10px; margin-bottom: 10px;">
            <label for="productName">ìƒí’ˆëª…:</label>
            <input type="text" id="productName" placeholder="ì˜ˆ: ì™€ì¸">
            <label for="currentPrice">í˜„ì¬ê°€ê²©:</label>
            <input type="number" id="currentPrice" placeholder="ì˜ˆ: 35000">
            <button onclick="fetchPrediction()">ê°€ê²© ì˜ˆì¸¡í•˜ê¸°</button>
        </div>
        <div style="margin-bottom: 5px;">
            <label for="trendData">ê°€ê²© ì¶”ì´ ë°ì´í„° (ê³¼ê±°â†’ìµœì‹  ìˆœ):</label>
            <input type="text" id="trendData" placeholder="ì˜ˆ: 34000,34500,35000 (3ì£¼ì „â†’2ì£¼ì „â†’1ì£¼ì „)" style="width: 400px; margin-left: 10px;">
        </div>
    </div>

    <!-- ì°¨íŠ¸ê°€ ê·¸ë ¤ì§ˆ ìº”ë²„ìŠ¤ ì˜ì—­ -->
    <div style="width: 80%; margin: auto;">
        <canvas id="myChart"></canvas>
    </div>

    <!-- ì£¼ì˜ì‚¬í•­ ë¬¸êµ¬ -->
    <div style="margin: 20px auto; padding: 15px; background-color: #fff3cd; border: 1px solid #ffeaa7; border-radius: 5px; width: 80%; text-align: center;">
        <p style="margin: 0; color: #856404; font-weight: bold;">âš ï¸ ì£¼ì˜ì‚¬í•­</p>
        <p style="margin: 5px 0 0 0; color: #856404; font-size: 14px;">
            ì´ ê°€ê²© ì˜ˆì¸¡ì€ AIì— ì˜í•œ ì¶”ì •ì¹˜ë¡œ ì‹¤ì œ ê°€ê²©ê³¼ ë‹¤ë¥¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>
            êµ¬ë§¤ ê²°ì • ì‹œ ì°¸ê³ ìš©ìœ¼ë¡œë§Œ í™œìš©í•´ ì£¼ì‹œê¸° ë°”ëë‹ˆë‹¤.
        </p>
    </div>

    <!-- AIì˜ ì˜ˆì¸¡ ì„¤ëª…ì´ í‘œì‹œë  ì˜ì—­ -->
    <div id="explanation" style="margin: 20px auto; padding: 15px; border: 1px solid #dee2e6; border-radius: 5px; background-color: #e9ecef; width: 80%; display: none;">
        <p style="margin: 0 0 10px 0; color: #495057; font-weight: bold;">ğŸ¤– AI ì˜ˆì¸¡ ë¶„ì„</p>
        <div id="explanationContent" style="color: #495057; font-size: 14px; line-height: 1.4;"></div>
    </div>

    <script>
        // ì°¨íŠ¸ë¥¼ ê·¸ë¦´ ìº”ë²„ìŠ¤ ìš”ì†Œë¥¼ ê°€ì ¸ì˜´
        const ctx = document.getElementById('myChart');
        
        // Chart.jsë¥¼ ì‚¬ìš©í•˜ì—¬ ì„  ê·¸ë˜í”„ ì°¨íŠ¸ ìƒì„±
        let myChart = new Chart(ctx, {
            type: 'line', // ì„  ê·¸ë˜í”„ íƒ€ì…
            data: {
                labels: [], // xì¶• ë ˆì´ë¸” (ê³¼ê±° ë°ì´í„° + ì˜ˆì¸¡ ë°ì´í„°)
                datasets: [
                    {
                        label: 'ì‹¤ì œ ê°€ê²© ì¶”ì´',
                        data: [], // ê³¼ê±° ê°€ê²© ë°ì´í„°
                        fill: false,
                        borderColor: 'rgb(54, 162, 235)', // íŒŒë€ìƒ‰ ì‹¤ì„ 
                        backgroundColor: 'rgb(54, 162, 235)',
                        tension: 0.1,
                        borderWidth: 2
                    },
                    {
                        label: 'AI ì˜ˆì¸¡ ê°€ê²©',
                        data: [], // ì˜ˆì¸¡ëœ ê°€ê²© ë°ì´í„°
                        fill: false,
                        borderColor: 'rgb(255, 99, 132)', // ë¹¨ê°„ìƒ‰ ì ì„ 
                        backgroundColor: 'rgb(255, 99, 132)',
                        borderDash: [5, 5], // ì ì„  ìŠ¤íƒ€ì¼
                        tension: 0.1,
                        borderWidth: 2
                    }
                ]
            },
            options: {
                responsive: true,
                interaction: {
                    // íˆ´íŒ : Chart.jsì—ì„œ ê¸°ë³¸ìœ¼ë¡œ ì œê³µí•˜ëŠ” ê¸°ëŠ¥
                    intersect: false //  ì„  ìœ„ê°€ ì•„ë‹Œ ì „ì²´ xì¶• ì˜ì—­ì—ì„œ íˆ´íŒì´ í™œì„±í™”ë˜ë„ë¡ í•¨
                },
                scales: {
                    y: {
                        beginAtZero: false, // yì¶•ì´ 0ë¶€í„° ì‹œì‘í•˜ì§€ ì•Šë„ë¡ ì„¤ì •
                        title: {
                            display: true,
                            text: 'ê°€ê²© (ì›)'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'ê¸°ê°„'
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    }
                }
            }
        });

        // ë¹„ë™ê¸° í•¨ìˆ˜: ì„œë²„ì—ì„œ ê°€ê²© ì˜ˆì¸¡ ë°ì´í„°ë¥¼ ë°›ì•„ì™€ì„œ ì°¨íŠ¸ë¥¼ ì—…ë°ì´íŠ¸
        // async function : ë¹„ë™ê¸° ì½”ë“œ(fetch)ë¥¼ ë§ˆì¹˜ ë™ê¸° ì½”ë“œì²˜ëŸ¼ ìˆœì„œëŒ€ë¡œ ì“°ê²Œ í•´ì£¼ëŠ” ë¬¸ë²•
        async function fetchPrediction() {
            // ì‚¬ìš©ìê°€ ì…ë ¥í•œ ê°’ë“¤ì„ ê°€ì ¸ì˜´
            const productName = document.getElementById('productName').value;
            const currentPrice = document.getElementById('currentPrice').value;
            const trendData = document.getElementById('trendData').value;

            // í•„ìˆ˜ ì…ë ¥ ê°’ë“¤ì´ ëª¨ë‘ ì…ë ¥ë˜ì—ˆëŠ”ì§€ í™•ì¸
            if (!productName || !currentPrice || !trendData) {
                alert('ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            // RESTful API ìš”ì²­ì„ ìœ„í•œ ìš”ì²­ ë°ì´í„° ì¤€ë¹„
            const requestData = {
                productName: productName,
                currentPrice: parseFloat(currentPrice),
                trendData: trendData
            };

            try {
                // POST ë°©ì‹ìœ¼ë¡œ RESTful API í˜¸ì¶œ
                const response = await fetch('/api/predictions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });
                
                if (response.ok) {
                    // ì‘ë‹µì´ ì„±ê³µì ì¼ ë•Œ: JSON ë°ì´í„°ë¡œ ë³€í™˜
                    const data = await response.json();

                    // ì…ë ¥ëœ ê°€ê²© ì¶”ì´ ë°ì´í„°ë¥¼ ë°°ì—´ë¡œ ë³€í™˜ (ê³¼ê±°â†’ìµœì‹  ìˆœìœ¼ë¡œ ì…ë ¥ë°›ìŒ)
                    const trendArray = trendData.split(',').map(price => parseInt(price.trim()));
                    const trendLabels = trendArray.map((_, index) => `${trendArray.length - index}ì£¼ ì „`);
                    
                    // ì˜ˆì¸¡ ë°ì´í„°
                    const predictionData = [data.week1, data.week2, data.week3, data.week4];
                    const predictionLabels = ['1ì£¼ í›„', '2ì£¼ í›„', '3ì£¼ í›„', '4ì£¼ í›„'];

                    // ì°¨íŠ¸ ë°ì´í„° ì—…ë°ì´íŠ¸: ê³¼ê±° ë°ì´í„° + í˜„ì¬ + ì˜ˆì¸¡ ë°ì´í„°
                    myChart.data.labels = [...trendLabels, 'í˜„ì¬', ...predictionLabels]; // ì „ê°œ ì—°ì‚°ì(...) : ë°°ì—´ì„ í’€ì–´ì„œ ê°œë³„ ìš”ì†Œë“¤ë¡œ ë§Œë“œëŠ” ì—­í• 
                    
                    // ì‹¤ì œ ê°€ê²© ì¶”ì´ ë°ì´í„° (ê³¼ê±° ë°ì´í„° + í˜„ì¬ ê°€ê²©)
                    myChart.data.datasets[0].data = [...trendArray, parseInt(currentPrice), ...Array(4).fill(null)]; // ë¯¸ë˜ 4ê°œ êµ¬ê°„ì€ ë¹ˆ ê°’
                    
                    // ì˜ˆì¸¡ ê°€ê²© ë°ì´í„° (í˜„ì¬ ê°€ê²©ë¶€í„° ì‹œì‘í•˜ì—¬ ì˜ˆì¸¡ ë°ì´í„°ë¡œ ì—°ê²°)
                    myChart.data.datasets[1].data = [...Array(trendArray.length).fill(null), parseInt(currentPrice), ...predictionData]; // ê³¼ê±°ë°ì´í„° ê¸¸ì´ë§Œí¼ ë¹ˆ ê°’
                    
                    myChart.update(); // ì°¨íŠ¸ë¥¼ ë‹¤ì‹œ ê·¸ë¦¼

                    // AIì˜ ì˜ˆì¸¡ ì„¤ëª…ì„ í™”ë©´ì— í‘œì‹œ
                    document.getElementById('explanationContent').innerText = data.explanation;
                    document.getElementById('explanation').style.display = 'block';
                } else {
                    // HTTP ì—ëŸ¬ ì²˜ë¦¬ (404, 500 ë“±)
                    console.error('ì˜ˆì¸¡ ìš”ì²­ ì˜¤ë¥˜:', `HTTP ì—ëŸ¬! ìƒíƒœ: ${response.status}`);
                    alert('ê°€ê²© ì˜ˆì¸¡ì„ ê°€ì ¸ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì½˜ì†”ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
                }
            } catch (error) {
                // ë„¤íŠ¸ì›Œí¬ ì—ëŸ¬ë‚˜ JSON íŒŒì‹± ì—ëŸ¬ ì²˜ë¦¬
                console.error('ì˜ˆì¸¡ ìš”ì²­ ì˜¤ë¥˜:', error);
                alert('ê°€ê²© ì˜ˆì¸¡ì„ ê°€ì ¸ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
            }
        }
    </script>
</body>
</html>